<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pong</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root {
  --accent: #ff6fa3;
  --bg: #000;
  --button-bg: #111;
  --button-color: #fff;
  --button-radius: 8px;
}

body {
  margin: 0;
  font-family: 'Press Start 2P', cursive;
  background: var(--bg);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  overflow: hidden;
}

body.playing {
  align-items: flex-start;
  padding-top: 12px;
}

canvas {
  background: #000;
  border: 3px solid var(--accent);
  display: none;
  border-radius: 12px;
}

#menu {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  color: var(--accent);
  gap: 10px;
  width: 100%;
  max-width: 400px;
  padding: 1px;
  box-sizing: border-box;
}

#menu img.logo {
  max-width: 180px;
  height: auto;
  margin: 0;
  margin-bottom: 0;
}

button {
  font-family: 'Press Start 2P', cursive;
  padding: 12px 24px;
  font-size: clamp(0.7rem, 2.5vw, 1.1rem);
  border-radius: var(--button-radius);
  border: 2px solid var(--accent);
  background: var(--button-bg);
  color: var(--button-color);
  cursor: pointer;
  margin: 5px;
  transition: transform 0.2s, background 0.2s, color 0.2s;
}

button:hover {
  background: var(--accent);
  color: #000;
  transform: scale(1.05);
}

.character-select { width: 100%; }
.character-select p { margin: 0; text-align: center; }
.character-select div {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  justify-items: center;
}
.character-select img {
  width: 80px;
  height: 80px;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: border 0.2s;
}
.character-select img.selected { border: 2px solid var(--accent); }
</style>
</head>
<body>
<div id="menu">
  <img src="images/pong.png" class="logo" alt="Pong Logo">

  <div class="character-select">
    <p>Player 1:</p>
    <div id="bottomChoices"></div>
  </div>
  <div class="character-select">
    <p>Player 2:</p>
    <div id="topChoices"></div>
  </div>

<div style="text-align:center; margin:10px 0;">
  <label>Difficulty: <input type="range" id="cpuRange" min="1" max="10" value="4"></label>
</div>

  <div>
    <label><input type="radio" name="mode" value="1" checked> 1 Player</label>
    <label><input type="radio" name="mode" value="2"> 2 Players</label>
  </div>

  <button id="startBtn">Play</button>
</div>

<canvas id="gameCanvas" width="400" height="700"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const menu = document.getElementById("menu");
const startBtn = document.getElementById("startBtn");
const cpuRange = document.getElementById("cpuRange");

const bottomChoices = document.getElementById("bottomChoices");
const topChoices = document.getElementById("topChoices");

// Characters
const characters = [
  {src: "images/hello-kitty.png", name: "Hello Kitty"},
  {src: "images/labubu.png", name: "Labubu"},
  {src: "images/kuromi.png", name: "Kuromi"},
  {src: "images/coraline.png", name: "Coraline"}
];

let bottomImg = null, topImg = null;
let bottomName = "", topName = "";

let mode = 1;
let keys = {};
let gameWidth = 400, gameHeight = 700;
const paddleWidth = 80, paddleHeight = 15;
const ballSize = 15;
let player1, player2, ball;
let score1, score2;
let bounceBottom = 0, bounceTop = 0;
let rallyCount = 0;

function createCharacterChoices(container, setImg, setName){
  container.innerHTML = "";
  characters.forEach((ch)=>{
    const img = new Image();
    img.src = ch.src;
    img.addEventListener("click", ()=>{
      container.querySelectorAll("img").forEach(i=>i.classList.remove("selected"));
      img.classList.add("selected");
      setImg(img);
      setName(ch.name);
    });
    container.appendChild(img);
  });
}
createCharacterChoices(bottomChoices, img=>bottomImg=img, name=>bottomName=name);
createCharacterChoices(topChoices, img=>topImg=img, name=>topName=name);

function resetGame(){
  player1 = {x: gameWidth/2 - paddleWidth/2, y: gameHeight - paddleHeight - 10};
  player2 = {x: gameWidth/2 - paddleWidth/2, y: 10};
  ball = {x: gameWidth/2 - ballSize/2, y: gameHeight/2 - ballSize/2, dx: 4, dy: 4};
  score1 = 0; score2 = 0;
  bounceBottom = 0; bounceTop = 0;
  rallyCount = 0;
}

function setViewportHeight() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
  document.body.style.minHeight = `${window.innerHeight}px`;
}
setViewportHeight();
window.addEventListener('resize', setViewportHeight);

function resizeCanvas(){
  const designW = 400, designH = 700;
  const maxH = Math.max(200, window.innerHeight-40);
  const targetH = Math.min(designH, maxH);
  const aspect = designW/designH;
  const targetW = Math.round(targetH*aspect);
  canvas.style.width = targetW+'px';
  canvas.style.height = targetH+'px';
  gameWidth = targetW;
  gameHeight = targetH;
}

canvas.addEventListener('touchstart', e=>{
  for(let touch of e.touches){
    const x = touch.clientX;
    const y = touch.clientY;
    if(y > gameHeight/2){ if(x < gameWidth/2) keys['ArrowLeft']=true; else keys['ArrowRight']=true; }
    else { if(x < gameWidth/2) keys['a']=true; else keys['d']=true; }
  }
},{passive:false});
canvas.addEventListener('touchend', e=>{ keys['ArrowLeft']=false; keys['ArrowRight']=false; keys['a']=false; keys['d']=false; });

function draw(){
  ctx.clearRect(0,0,gameWidth,gameHeight);
  ctx.fillStyle = '#ff6fa3';
  ctx.fillRect(player1.x, player1.y, paddleWidth, paddleHeight);
  ctx.fillRect(player2.x, player2.y, paddleWidth, paddleHeight);

  if(bottomImg){
    const h = paddleHeight*4;
    const w = h * (bottomImg.naturalWidth/bottomImg.naturalHeight);
    ctx.drawImage(bottomImg, player1.x + paddleWidth/2 - w/2, player1.y - h - bounceBottom, w, h);
  }
  if(topImg){
    const h = paddleHeight*4;
    const w = h * (topImg.naturalWidth/topImg.naturalHeight);
    const x = player2.x + paddleWidth/2 - w/2;
    const y = player2.y + paddleHeight + bounceTop;

    if(mode === 2){
      ctx.save();
      ctx.translate(x + w/2, y + h/2);
      ctx.rotate(Math.PI);
      ctx.drawImage(topImg, -w/2, -h/2, w, h);
      ctx.restore();
    } else {
      ctx.drawImage(topImg, x, y, w, h);
    }
  }

  ctx.fillStyle = '#fff';
  ctx.fillRect(ball.x, ball.y, ballSize, ballSize);

  ctx.fillStyle = '#ff6fa3';
  ctx.font = "16px 'Press Start 2P'";
  ctx.fillText(`${topName}: ${score2}`, 10, 25);
  ctx.fillText(`${bottomName}: ${score1}`, 10, gameHeight-10);
}

function update(){
  if(keys["ArrowLeft"]) player1.x -= 6;
  if(keys["ArrowRight"]) player1.x += 6;
  player1.x = Math.max(0, Math.min(gameWidth - paddleWidth, player1.x));

  const cpuSpeed = parseInt(cpuRange.value);
  if(mode===1){
    const target = ball.x + ballSize/2;
    const center = player2.x + paddleWidth/2;
    if(target < center) player2.x -= cpuSpeed;
    else if(target > center) player2.x += cpuSpeed;
  } else {
    if(keys["a"]||keys["A"]) player2.x -= 6;
    if(keys["d"]||keys["D"]) player2.x += 6;
  }
  player2.x = Math.max(0, Math.min(gameWidth - paddleWidth, player2.x));

  ball.x += ball.dx;
  ball.y += ball.dy;
  if(ball.x <= 0 || ball.x + ballSize >= gameWidth) ball.dx *= -1;

  // ---- Updated collision code ----
  if(
    ball.y + ballSize >= player1.y &&
    ball.y <= player1.y + paddleHeight &&
    ball.x + ballSize >= player1.x &&
    ball.x <= player1.x + paddleWidth
  ){
    ball.dy *= -1;
    ball.y = player1.y - ballSize;
    bounceBottom = 12;
    rallyCount++;
    if(Math.abs(ball.dx) < 10) ball.dx *= 1.05;
    if(Math.abs(ball.dy) < 10) ball.dy *= 1.05;
  }

  if(
    ball.y <= player2.y + paddleHeight &&
    ball.y + ballSize >= player2.y &&
    ball.x + ballSize >= player2.x &&
    ball.x <= player2.x + paddleWidth
  ){
    ball.dy *= -1;
    ball.y = player2.y + paddleHeight;
    bounceTop = 12;
    rallyCount++;
    if(Math.abs(ball.dx) < 10) ball.dx *= 1.05;
    if(Math.abs(ball.dy) < 10) ball.dy *= 1.05;
  }
  // -------------------------------

  bounceBottom *= 0.6;
  bounceTop *= 0.6;

  if(ball.y < 0){ score1++; resetBall(1); rallyCount=0; }
  if(ball.y > gameHeight){ score2++; resetBall(-1); rallyCount=0; }
}

function resetBall(direction){
  ball.x = gameWidth/2 - ballSize/2;
  ball.y = gameHeight/2 - ballSize/2;
  ball.dx = 4 * (Math.random()>0.5?1:-1);
  ball.dy = 4 * direction;
}

function gameLoop(){
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

document.addEventListener("keydown", e=>keys[e.key]=true);
document.addEventListener("keyup", e=>keys[e.key]=false);

startBtn.addEventListener("click", ()=>{
  mode = parseInt(document.querySelector("input[name='mode']:checked").value);
  if(!bottomImg || !topImg){ alert("Select characters for both players!"); return; }
  document.body.classList.add('playing');
  menu.style.display="none";
  canvas.style.display="block";
  resizeCanvas();
  resetGame();
  gameLoop();
});
</script>
</body>
</html>
